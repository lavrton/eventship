'use strict';

angular.module('mie.store', []).service('store', ['$rootScope', function ($rootScope) {
    var ref = new Firebase('https://incandescent-fire-1476.firebaseio.com/');

    function Store() {
        this._localEventsCopy = [];
        this.lastSyncTime = new Date(localStorage.getItem('lastSync'));
    }

    function isValidEventObject(obj) {
        // event must be object, not array
        if (obj instanceof Array) {
            return false;
        }
        // wrong data
        return !(!obj.type || !obj.id);
    }

    // PUBLIC METHODS
    Store.prototype.onUpdate = function (func) {
        var userRef = ref.child('users').child($rootScope.user.uid);
        var eventsRef = userRef.child('events');

        function update(snap) {
            if (this._justSaved) {
                this._justSaved = false;
                return;
            }
            var events = snap.val();
            this._mergeFromRemote(events);
            func(this._prepareData(events));
        }

        // disable as too slow for now
        //eventsRef.on('value', update, this);
    };

    Store.prototype.save = function (event) {
        // TODO: rewrite to method
        event.updated = Date.now();
        var data = event.toObject();

        this._saveEventToLocal(data);
        this._saveEventToRemote(data);
    };

    Store.prototype.load = function (cb) {
        try {
            this._localEventsCopy = JSON.parse(localStorage.getItem('events') || '[]');
            this._filter();
            this._localEventsCopy.forEach(function (e) {
                e.updated = e.updated || Date.now();
            });
            this._saveAllLocal();
        } catch (e) {
            this._localEventsCopy = [];
            // throw error in async way for debugging information
            setTimeout(function () {
                throw e;
            });
        }
        this._sync();
        cb(this._prepareData(this._localEventsCopy));
    };

    Store.prototype._filter = function () {
        this._localEventsCopy = this._localEventsCopy.filter(isValidEventObject);
    };

    Store.prototype.setting = function (key, value) {
        var userRef = ref.child('users').child($rootScope.user.uid);
        if (typeof value !== 'undefined') {
            // setter
            userRef.child('settings').child(key).set(value);
            localStorage.setItem(key, value);
        } else {
            var promise = new Promise(function (resolve) {
                var localValue = localStorage.getItem(key);
                if (!localValue) {
                    userRef.child('settings').child(key).once('value', function (snap) {
                        var val = snap.val();
                        localStorage.setItem(key, val);
                        resolve(val);
                    });
                } else {
                    resolve(localValue);
                }
            });
            return promise;
        }
    };

    // PRIVATE METHODS

    Store.prototype._getRemoteEvents = function (cb) {
        var userRef = ref.child('users').child($rootScope.user.uid);
        var eventsRef = userRef.child('events');

        eventsRef.once('value', function (snap) {
            var events = snap.val();
            cb(events);
        });
    };

    Store.prototype._sync = function () {
        var _this = this;

        this._getRemoteEvents(function (events) {
            var updated = false;
            _.each(events, function (remote) {
                if (!isValidEventObject(remote)) {
                    return;
                }
                var local = _.find(_this._localEventsCopy, function (e) {
                    return e.id + e.type === remote.id + remote.type;
                });
                if (!local || remote.updated && local.updated < remote.updated) {
                    _this._saveEventToLocal(remote);
                    updated = true;
                }
                if (!remote.updated || local.updated > remote.updated) {
                    _this._saveEventToRemote(local);
                }
            });
            _.each(_this._localEventsCopy, function (local) {
                var remote = _.find(events, function (e) {
                    return e.id + e.type === local.id + local.type;
                });
                if (!remote || !remote.updated || remote.updated < local.updated) {
                    _this._saveEventToRemote(local);
                }
                if (remote.updated && local.updated < remote.updated) {
                    _this._saveEventToLocal(remote);
                    updated = true;
                }
            });
            //if (updated) {
            //    this.
            //}
        });
        //let i = 0;
        //let delay = 5;
        //let save = () => {
        //    let event = this._localEventsCopy[i];
        //    this._saveEventToRemote(event);
        //    i++;
        //    if (i < this._localEventsCopy.length - 1) {
        //        setTimeout(save, delay);
        //    }
        //};
        //save();

        //this._localEventsCopy.forEach((e) => {
        //    this._saveEventToRemote(e);
        //});
        setTimeout(function () {
            _this._sync();
        }, 60 * 1000);
    };

    Store.prototype._mergeFromRemote = function (events) {
        var _this2 = this;

        _.each(events, function (remoteEvent) {
            if (isValidEventObject(remoteEvent)) {
                _this2._saveEventToLocal(remoteEvent);
            }
        });
    };

    Store.prototype._prepareData = function (data) {
        // data is array of all events
        var dayEvents = [];
        var nestedEvents = [];
        _.each(data, function (obj) {
            if (obj.type === 'day') {
                dayEvents.push(obj);
            } else {
                nestedEvents.push(obj);
            }
        });
        return {
            dayEvents: dayEvents, nestedEvents: nestedEvents
        };
    };

    Store.prototype._saveEventToLocal = function (event) {
        var toUpdate = _.find(this._localEventsCopy, function (e) {
            return e.id === event.id && e.type === event.type;
        });
        if (toUpdate) {
            _.merge(toUpdate, event);
        } else {
            if (event instanceof Array) {
                debugger;
                return;
            }
            this._localEventsCopy.push(event);
        }
        this._saveAllLocal();
    };

    Store.prototype._saveAllLocal = _.debounce(function () {
        localStorage.setItem('events', JSON.stringify(this._localEventsCopy));
    }, 50);

    Store.prototype._saveEventToRemote = function (event) {
        this._justSaved = true;
        var userRef = ref.child('users').child($rootScope.user.uid);
        var eventsRef = userRef.child('events');
        if (!event.type) {
            debugger;
        }
        eventsRef.child(event.type + '-' + event.id).update(event);
    };

    return new Store();
}]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0b3JlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLFlBQVksRUFBRSxVQUFDLFVBQVUsRUFBSztBQUM1RSxRQUFJLEdBQUcsR0FBRyxJQUFJLFFBQVEsQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDOztBQUV6RSxhQUFTLEtBQUssR0FBRztBQUNiLFlBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDM0IsWUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7S0FDbEU7O0FBRUQsYUFBUyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUU7O0FBRTdCLFlBQUksR0FBRyxZQUFZLEtBQUssRUFBRTtBQUN0QixtQkFBTyxLQUFLLENBQUM7U0FDaEI7O0FBRUQsZUFBTyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUEsQUFBQyxDQUFDO0tBQ2xDOzs7QUFJRCxTQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxVQUFVLElBQUksRUFBRTtBQUN2QyxZQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVELFlBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7O0FBRXhDLGlCQUFTLE1BQU0sQ0FBQyxJQUFJLEVBQUU7QUFDbEIsZ0JBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtBQUNqQixvQkFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDeEIsdUJBQU87YUFDVjtBQUNELGdCQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDeEIsZ0JBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM5QixnQkFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztTQUNuQzs7OztBQUFBLEtBSUosQ0FBQzs7QUFFRixTQUFLLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxVQUFVLEtBQUssRUFBRTs7QUFFcEMsYUFBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDM0IsWUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDOztBQUU1QixZQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDN0IsWUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ2pDLENBQUM7O0FBRUYsU0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsVUFBVSxFQUFFLEVBQUU7QUFDakMsWUFBSTtBQUNBLGdCQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO0FBQzNFLGdCQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDZixnQkFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxVQUFDLENBQUMsRUFBSztBQUNqQyxpQkFBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQzthQUN2QyxDQUFDLENBQUM7QUFDSCxnQkFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3hCLENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDUixnQkFBSSxDQUFDLGdCQUFnQixHQUFHLEVBQUUsQ0FBQzs7QUFFM0Isc0JBQVUsQ0FBQyxZQUFNO0FBQ2Isc0JBQU0sQ0FBQyxDQUFDO2FBQ1gsQ0FBQyxDQUFDO1NBQ047QUFDRCxZQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDYixVQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO0tBQ2hELENBQUM7O0FBRUYsU0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsWUFBVztBQUNqQyxZQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0tBQzVFLENBQUM7O0FBRUYsU0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBVSxHQUFHLEVBQUUsS0FBSyxFQUFFO0FBQzVDLFlBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDNUQsWUFBSSxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUU7O0FBQzlCLG1CQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDaEQsd0JBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3BDLE1BQU07QUFDSCxnQkFBSSxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUs7QUFDbkMsb0JBQUksVUFBVSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDM0Msb0JBQUksQ0FBQyxVQUFVLEVBQUU7QUFDYiwyQkFBTyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFDLElBQUksRUFBSztBQUN6RCw0QkFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLG9DQUFZLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMvQiwrQkFBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUNoQixDQUFDLENBQUM7aUJBQ04sTUFBTTtBQUNILDJCQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7aUJBQ3ZCO2FBQ0osQ0FBQyxDQUFDO0FBQ0gsbUJBQU8sT0FBTyxDQUFDO1NBQ2xCO0tBQ0osQ0FBQzs7OztBQUtGLFNBQUssQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsVUFBUyxFQUFFLEVBQUU7QUFDNUMsWUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM1RCxZQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUV4QyxpQkFBUyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDOUIsZ0JBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUN4QixjQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDZCxDQUFDLENBQUM7S0FDTixDQUFDOztBQUVGLFNBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLFlBQVk7OztBQUNoQyxZQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBQyxNQUFNLEVBQUs7QUFDOUIsZ0JBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztBQUNwQixhQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxVQUFDLE1BQU0sRUFBSztBQUN2QixvQkFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxFQUFFO0FBQzdCLDJCQUFPO2lCQUNWO0FBQ0Qsb0JBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBSyxnQkFBZ0IsRUFBRSxVQUFDLENBQUMsRUFBSztBQUM3QywyQkFBTyxBQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksS0FBTyxNQUFNLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLEFBQUMsQ0FBQztpQkFDeEQsQ0FBQyxDQUFDO0FBQ0gsb0JBQUksQ0FBQyxLQUFLLElBQUksTUFBTSxDQUFDLE9BQU8sSUFBSyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLEFBQUMsRUFBRTtBQUM5RCwwQkFBSyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQiwyQkFBTyxHQUFHLElBQUksQ0FBQztpQkFDbEI7QUFDRCxvQkFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFO0FBQ25ELDBCQUFLLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNsQzthQUNKLENBQUMsQ0FBQztBQUNILGFBQUMsQ0FBQyxJQUFJLENBQUMsTUFBSyxnQkFBZ0IsRUFBRSxVQUFDLEtBQUssRUFBSztBQUNyQyxvQkFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBQyxDQUFDLEVBQUs7QUFDL0IsMkJBQU8sQUFBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLEtBQU8sS0FBSyxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUMsSUFBSSxBQUFDLENBQUM7aUJBQ3RELENBQUMsQ0FBQztBQUNILG9CQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sSUFBSyxNQUFNLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLEFBQUMsRUFBRTtBQUNoRSwwQkFBSyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDbEM7QUFDRCxvQkFBSSxNQUFNLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRTtBQUNsRCwwQkFBSyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQiwyQkFBTyxHQUFHLElBQUksQ0FBQztpQkFDbEI7YUFDSixDQUFDLENBQUM7Ozs7U0FJTixDQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7QUFnQkgsa0JBQVUsQ0FBQyxZQUFNO0FBQ2Isa0JBQUssS0FBSyxFQUFFLENBQUM7U0FDaEIsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7S0FDakIsQ0FBQzs7QUFFRixTQUFLLENBQUMsU0FBUyxDQUFDLGdCQUFnQixHQUFHLFVBQVUsTUFBTSxFQUFFOzs7QUFDakQsU0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBQyxXQUFXLEVBQUs7QUFDNUIsZ0JBQUksa0JBQWtCLENBQUMsV0FBVyxDQUFDLEVBQUU7QUFDakMsdUJBQUssaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDdkM7U0FDSixDQUFDLENBQUM7S0FDTixDQUFDOztBQUVGLFNBQUssQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHLFVBQVUsSUFBSSxFQUFFOztBQUUzQyxZQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7QUFDbkIsWUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLFNBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFVBQUMsR0FBRyxFQUFLO0FBQ2xCLGdCQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssS0FBSyxFQUFFO0FBQ3BCLHlCQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZCLE1BQU07QUFDSCw0QkFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNKLENBQUMsQ0FBQztBQUNILGVBQU87QUFDSCxxQkFBUyxFQUFULFNBQVMsRUFBRSxZQUFZLEVBQVosWUFBWTtTQUMxQixDQUFDO0tBQ0wsQ0FBQzs7QUFFRixTQUFLLENBQUMsU0FBUyxDQUFDLGlCQUFpQixHQUFHLFVBQVUsS0FBSyxFQUFFO0FBQ2pELFlBQUksUUFBUSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLFVBQUMsQ0FBQzttQkFBSyxDQUFDLENBQUMsRUFBRSxLQUFLLEtBQUssQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxLQUFLLENBQUMsSUFBSTtTQUFBLENBQUMsQ0FBQztBQUNoRyxZQUFJLFFBQVEsRUFBRTtBQUNWLGFBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzVCLE1BQU07QUFDSCxnQkFBSSxLQUFLLFlBQVksS0FBSyxFQUFFO0FBQ3hCLHlCQUFTO0FBQ1QsdUJBQU87YUFDVjtBQUNELGdCQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3JDO0FBQ0QsWUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0tBQ3hCLENBQUM7O0FBRUYsU0FBSyxDQUFDLFNBQVMsQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxZQUFXO0FBQ2xELG9CQUFZLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7S0FDekUsRUFBRSxFQUFFLENBQUMsQ0FBQzs7QUFFUCxTQUFLLENBQUMsU0FBUyxDQUFDLGtCQUFrQixHQUFHLFVBQVUsS0FBSyxFQUFFO0FBQ2xELFlBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLFlBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDNUQsWUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN4QyxZQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtBQUNiLHFCQUFTO1NBQ1o7QUFDRCxpQkFBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzlELENBQUM7O0FBRUYsV0FBTyxJQUFJLEtBQUssRUFBRSxDQUFDO0NBQ3RCLENBQUMsQ0FBQyxDQUFDIiwiZmlsZSI6InN0b3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiYW5ndWxhci5tb2R1bGUoJ21pZS5zdG9yZScsIFtdKS5zZXJ2aWNlKCdzdG9yZScsIFsnJHJvb3RTY29wZScsICgkcm9vdFNjb3BlKSA9PiB7XG4gICAgbGV0IHJlZiA9IG5ldyBGaXJlYmFzZSgnaHR0cHM6Ly9pbmNhbmRlc2NlbnQtZmlyZS0xNDc2LmZpcmViYXNlaW8uY29tLycpO1xuXG4gICAgZnVuY3Rpb24gU3RvcmUoKSB7XG4gICAgICAgIHRoaXMuX2xvY2FsRXZlbnRzQ29weSA9IFtdO1xuICAgICAgICB0aGlzLmxhc3RTeW5jVGltZSA9IG5ldyBEYXRlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYXN0U3luYycpKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBpc1ZhbGlkRXZlbnRPYmplY3Qob2JqKSB7XG4gICAgICAgIC8vIGV2ZW50IG11c3QgYmUgb2JqZWN0LCBub3QgYXJyYXlcbiAgICAgICAgaWYgKG9iaiBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgLy8gd3JvbmcgZGF0YVxuICAgICAgICByZXR1cm4gISghb2JqLnR5cGUgfHwgIW9iai5pZCk7XG4gICAgfVxuXG5cbiAgICAvLyBQVUJMSUMgTUVUSE9EU1xuICAgIFN0b3JlLnByb3RvdHlwZS5vblVwZGF0ZSA9IGZ1bmN0aW9uIChmdW5jKSB7XG4gICAgICAgIGxldCB1c2VyUmVmID0gcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKCRyb290U2NvcGUudXNlci51aWQpO1xuICAgICAgICBsZXQgZXZlbnRzUmVmID0gdXNlclJlZi5jaGlsZCgnZXZlbnRzJyk7XG5cbiAgICAgICAgZnVuY3Rpb24gdXBkYXRlKHNuYXApIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9qdXN0U2F2ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9qdXN0U2F2ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsZXQgZXZlbnRzID0gc25hcC52YWwoKTtcbiAgICAgICAgICAgIHRoaXMuX21lcmdlRnJvbVJlbW90ZShldmVudHMpO1xuICAgICAgICAgICAgZnVuYyh0aGlzLl9wcmVwYXJlRGF0YShldmVudHMpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGRpc2FibGUgYXMgdG9vIHNsb3cgZm9yIG5vd1xuICAgICAgICAvL2V2ZW50c1JlZi5vbigndmFsdWUnLCB1cGRhdGUsIHRoaXMpO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuc2F2ZSA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAvLyBUT0RPOiByZXdyaXRlIHRvIG1ldGhvZFxuICAgICAgICBldmVudC51cGRhdGVkID0gRGF0ZS5ub3coKTtcbiAgICAgICAgbGV0IGRhdGEgPSBldmVudC50b09iamVjdCgpO1xuXG4gICAgICAgIHRoaXMuX3NhdmVFdmVudFRvTG9jYWwoZGF0YSk7XG4gICAgICAgIHRoaXMuX3NhdmVFdmVudFRvUmVtb3RlKGRhdGEpO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUubG9hZCA9IGZ1bmN0aW9uIChjYikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5fbG9jYWxFdmVudHNDb3B5ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZXZlbnRzJykgfHwgJ1tdJyk7XG4gICAgICAgICAgICB0aGlzLl9maWx0ZXIoKTtcbiAgICAgICAgICAgIHRoaXMuX2xvY2FsRXZlbnRzQ29weS5mb3JFYWNoKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgZS51cGRhdGVkID0gZS51cGRhdGVkIHx8IERhdGUubm93KCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuX3NhdmVBbGxMb2NhbCgpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICB0aGlzLl9sb2NhbEV2ZW50c0NvcHkgPSBbXTtcbiAgICAgICAgICAgIC8vIHRocm93IGVycm9yIGluIGFzeW5jIHdheSBmb3IgZGVidWdnaW5nIGluZm9ybWF0aW9uXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fc3luYygpO1xuICAgICAgICBjYih0aGlzLl9wcmVwYXJlRGF0YSh0aGlzLl9sb2NhbEV2ZW50c0NvcHkpKTtcbiAgICB9O1xuXG4gICAgU3RvcmUucHJvdG90eXBlLl9maWx0ZXIgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5fbG9jYWxFdmVudHNDb3B5ID0gdGhpcy5fbG9jYWxFdmVudHNDb3B5LmZpbHRlcihpc1ZhbGlkRXZlbnRPYmplY3QpO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuc2V0dGluZyA9IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7XG4gICAgICAgIGxldCB1c2VyUmVmID0gcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKCRyb290U2NvcGUudXNlci51aWQpO1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgeyAvLyBzZXR0ZXJcbiAgICAgICAgICAgIHVzZXJSZWYuY2hpbGQoJ3NldHRpbmdzJykuY2hpbGQoa2V5KS5zZXQodmFsdWUpO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCB2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsZXQgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IGxvY2FsVmFsdWUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgICAgICAgICAgICAgIGlmICghbG9jYWxWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB1c2VyUmVmLmNoaWxkKCdzZXR0aW5ncycpLmNoaWxkKGtleSkub25jZSgndmFsdWUnLCAoc25hcCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHZhbCA9IHNuYXAudmFsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHZhbCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUobG9jYWxWYWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICAgICAgfVxuICAgIH07XG5cblxuICAgIC8vIFBSSVZBVEUgTUVUSE9EU1xuXG4gICAgU3RvcmUucHJvdG90eXBlLl9nZXRSZW1vdGVFdmVudHMgPSBmdW5jdGlvbihjYikge1xuICAgICAgICBsZXQgdXNlclJlZiA9IHJlZi5jaGlsZCgndXNlcnMnKS5jaGlsZCgkcm9vdFNjb3BlLnVzZXIudWlkKTtcbiAgICAgICAgbGV0IGV2ZW50c1JlZiA9IHVzZXJSZWYuY2hpbGQoJ2V2ZW50cycpO1xuXG4gICAgICAgIGV2ZW50c1JlZi5vbmNlKCd2YWx1ZScsIChzbmFwKSA9PiB7XG4gICAgICAgICAgICBsZXQgZXZlbnRzID0gc25hcC52YWwoKTtcbiAgICAgICAgICAgIGNiKGV2ZW50cyk7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuX3N5bmMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuX2dldFJlbW90ZUV2ZW50cygoZXZlbnRzKSA9PiB7XG4gICAgICAgICAgICBsZXQgdXBkYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgXy5lYWNoKGV2ZW50cywgKHJlbW90ZSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghaXNWYWxpZEV2ZW50T2JqZWN0KHJlbW90ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsZXQgbG9jYWwgPSBfLmZpbmQodGhpcy5fbG9jYWxFdmVudHNDb3B5LCAoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKGUuaWQgKyBlLnR5cGUpID09PSAocmVtb3RlLmlkICsgcmVtb3RlLnR5cGUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmICghbG9jYWwgfHwgcmVtb3RlLnVwZGF0ZWQgJiYgKGxvY2FsLnVwZGF0ZWQgPCByZW1vdGUudXBkYXRlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2F2ZUV2ZW50VG9Mb2NhbChyZW1vdGUpO1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFyZW1vdGUudXBkYXRlZCB8fCBsb2NhbC51cGRhdGVkID4gcmVtb3RlLnVwZGF0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2F2ZUV2ZW50VG9SZW1vdGUobG9jYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXy5lYWNoKHRoaXMuX2xvY2FsRXZlbnRzQ29weSwgKGxvY2FsKSA9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHJlbW90ZSA9IF8uZmluZChldmVudHMsIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoZS5pZCArIGUudHlwZSkgPT09IChsb2NhbC5pZCArIGxvY2FsLnR5cGUpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmICghcmVtb3RlIHx8ICFyZW1vdGUudXBkYXRlZCB8fCAocmVtb3RlLnVwZGF0ZWQgPCBsb2NhbC51cGRhdGVkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zYXZlRXZlbnRUb1JlbW90ZShsb2NhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyZW1vdGUudXBkYXRlZCAmJiBsb2NhbC51cGRhdGVkIDwgcmVtb3RlLnVwZGF0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2F2ZUV2ZW50VG9Mb2NhbChyZW1vdGUpO1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vaWYgKHVwZGF0ZWQpIHtcbiAgICAgICAgICAgIC8vICAgIHRoaXMuXG4gICAgICAgICAgICAvL31cbiAgICAgICAgfSk7XG4gICAgICAgIC8vbGV0IGkgPSAwO1xuICAgICAgICAvL2xldCBkZWxheSA9IDU7XG4gICAgICAgIC8vbGV0IHNhdmUgPSAoKSA9PiB7XG4gICAgICAgIC8vICAgIGxldCBldmVudCA9IHRoaXMuX2xvY2FsRXZlbnRzQ29weVtpXTtcbiAgICAgICAgLy8gICAgdGhpcy5fc2F2ZUV2ZW50VG9SZW1vdGUoZXZlbnQpO1xuICAgICAgICAvLyAgICBpKys7XG4gICAgICAgIC8vICAgIGlmIChpIDwgdGhpcy5fbG9jYWxFdmVudHNDb3B5Lmxlbmd0aCAtIDEpIHtcbiAgICAgICAgLy8gICAgICAgIHNldFRpbWVvdXQoc2F2ZSwgZGVsYXkpO1xuICAgICAgICAvLyAgICB9XG4gICAgICAgIC8vfTtcbiAgICAgICAgLy9zYXZlKCk7XG5cbiAgICAgICAgLy90aGlzLl9sb2NhbEV2ZW50c0NvcHkuZm9yRWFjaCgoZSkgPT4ge1xuICAgICAgICAvLyAgICB0aGlzLl9zYXZlRXZlbnRUb1JlbW90ZShlKTtcbiAgICAgICAgLy99KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9zeW5jKCk7XG4gICAgICAgIH0sIDYwICogMTAwMCk7XG4gICAgfTtcblxuICAgIFN0b3JlLnByb3RvdHlwZS5fbWVyZ2VGcm9tUmVtb3RlID0gZnVuY3Rpb24gKGV2ZW50cykge1xuICAgICAgICBfLmVhY2goZXZlbnRzLCAocmVtb3RlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGlmIChpc1ZhbGlkRXZlbnRPYmplY3QocmVtb3RlRXZlbnQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc2F2ZUV2ZW50VG9Mb2NhbChyZW1vdGVFdmVudCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuX3ByZXBhcmVEYXRhID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgLy8gZGF0YSBpcyBhcnJheSBvZiBhbGwgZXZlbnRzXG4gICAgICAgIGxldCBkYXlFdmVudHMgPSBbXTtcbiAgICAgICAgbGV0IG5lc3RlZEV2ZW50cyA9IFtdO1xuICAgICAgICBfLmVhY2goZGF0YSwgKG9iaikgPT4ge1xuICAgICAgICAgICAgaWYgKG9iai50eXBlID09PSAnZGF5Jykge1xuICAgICAgICAgICAgICAgIGRheUV2ZW50cy5wdXNoKG9iaik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5lc3RlZEV2ZW50cy5wdXNoKG9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF5RXZlbnRzLCBuZXN0ZWRFdmVudHNcbiAgICAgICAgfTtcbiAgICB9O1xuXG4gICAgU3RvcmUucHJvdG90eXBlLl9zYXZlRXZlbnRUb0xvY2FsID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgIGxldCB0b1VwZGF0ZSA9IF8uZmluZCh0aGlzLl9sb2NhbEV2ZW50c0NvcHksIChlKSA9PiBlLmlkID09PSBldmVudC5pZCAmJiBlLnR5cGUgPT09IGV2ZW50LnR5cGUpO1xuICAgICAgICBpZiAodG9VcGRhdGUpIHtcbiAgICAgICAgICAgIF8ubWVyZ2UodG9VcGRhdGUsIGV2ZW50KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChldmVudCBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICAgICAgZGVidWdnZXI7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5fbG9jYWxFdmVudHNDb3B5LnB1c2goZXZlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NhdmVBbGxMb2NhbCgpO1xuICAgIH07XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuX3NhdmVBbGxMb2NhbCA9IF8uZGVib3VuY2UoZnVuY3Rpb24oKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdldmVudHMnLCBKU09OLnN0cmluZ2lmeSh0aGlzLl9sb2NhbEV2ZW50c0NvcHkpKTtcbiAgICB9LCA1MCk7XG5cbiAgICBTdG9yZS5wcm90b3R5cGUuX3NhdmVFdmVudFRvUmVtb3RlID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgIHRoaXMuX2p1c3RTYXZlZCA9IHRydWU7XG4gICAgICAgIGxldCB1c2VyUmVmID0gcmVmLmNoaWxkKCd1c2VycycpLmNoaWxkKCRyb290U2NvcGUudXNlci51aWQpO1xuICAgICAgICBsZXQgZXZlbnRzUmVmID0gdXNlclJlZi5jaGlsZCgnZXZlbnRzJyk7XG4gICAgICAgIGlmICghZXZlbnQudHlwZSkge1xuICAgICAgICAgICAgZGVidWdnZXI7XG4gICAgICAgIH1cbiAgICAgICAgZXZlbnRzUmVmLmNoaWxkKGV2ZW50LnR5cGUgKyAnLScgKyBldmVudC5pZCkudXBkYXRlKGV2ZW50KTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIG5ldyBTdG9yZSgpO1xufV0pO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi9qc3NyYyJ9